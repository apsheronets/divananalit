CREATE TYPE exchange AS ENUM ('bitfinex', 'bitstamp', 'btce');
CREATE TYPE pair AS ENUM ('btcusd');
CREATE TABLE orderbooks (
  id serial NOT NULL,
  exchange exchange,
  pair pair,
  CONSTRAINT orderbooks_pkey PRIMARY KEY (id)
)
WITH (
  OIDS=FALSE
);
CREATE UNIQUE INDEX index_unique_orderbooks_on_exchange_and_pair
   ON orderbooks (exchange, pair);
INSERT INTO orderbooks(exchange, pair) VALUES ('bitfinex', 'btcusd');
CREATE TABLE orderbook_updates (
  id serial NOT NULL,
  orderbook_id integer NOT NULL,
  created_at timestamp without time zone,
  CONSTRAINT orderbook_updates_pkey PRIMARY KEY (id),
  CONSTRAINT orderbook_id_fk FOREIGN KEY (orderbook_id)
    REFERENCES orderbooks (id) MATCH SIMPLE
    ON DELETE RESTRICT
)
WITH (
  OIDS=FALSE
);
CREATE INDEX index_orderbook_updates_on_orderbook_id
ON orderbook_updates
USING btree
(orderbook_id);

CREATE TABLE orderbook_records (
  orderbook_update_id integer NOT NULL,
  bid boolean NOT NULL,
  timestamp timestamp without time zone NOT NULL,
  price numeric(16,8) NOT NULL,
  amount numeric(16,8) NOT NULL,
  CONSTRAINT orderbook_update_id_fk FOREIGN KEY (orderbook_update_id)
    REFERENCES orderbook_updates (id) MATCH SIMPLE
    ON DELETE RESTRICT
)
WITH (
  OIDS=FALSE
);
CREATE INDEX index_orderbook_records_on_orderbook_update_id
ON orderbook_records
USING btree
(orderbook_update_id);
CREATE INDEX index_orderbook_records_on_book_id_price_for_bids
ON orderbook_records
USING btree
(orderbook_update_id, price DESC)
WHERE bid = true;
CREATE INDEX index_orderbook_records_on_book_id_price_for_asks
ON orderbook_records
USING btree
(orderbook_update_id, price ASC)
WHERE bid = false;

CREATE TABLE trades (
  id serial NOT NULL,
  orderbook_id integer NOT NULL,
  price numeric(16,8) NOT NULL,
  amount numeric(16,8) NOT NULL,
  buy boolean NULL,
  timestamp timestamp without time zone NOT NULL,
  tid integer NULL, /* bitfinex crap */
  CONSTRAINT trades_pkey PRIMARY KEY (id),
  CONSTRAINT orderbook_id_fk FOREIGN KEY (orderbook_id)
    REFERENCES orderbooks (id) MATCH SIMPLE
    ON DELETE RESTRICT
)
WITH (
  OIDS=FALSE
);
CREATE INDEX index_trades_on_orderbook_id_and_timestamp
ON trades
USING btree
(orderbook_id, timestamp DESC);
CREATE INDEX index_trades_on_orderbook_id_and_tid
ON trades
USING btree
(orderbook_id, tid DESC NULLS LAST);

CREATE TYPE currency AS ENUM ('btc', 'usd', 'ltc');
CREATE TABLE lends (
  exchange exchange NOT NULL,
  currency currency NOT NULL,
  rate numeric(9,4) NOT NULL,
  amount numeric(16,8) NOT NULL,
  timestamp timestamp without time zone NOT NULL
)
WITH (
  OIDS=FALSE
);
CREATE INDEX index_lends_on_currency_and_exchange_and_timestamp
ON lends
USING btree
(currency, exchange, timestamp DESC);

